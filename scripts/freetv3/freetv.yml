name: 'Update FreeTV â˜ âœ”ï¸'

on:
  schedule:
    - cron: '30 20 * * *'
  workflow_dispatch:

env:
  HISTORY_DIR: 'history/freetv'

jobs:
  run_job:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: ğŸ“¥ æ‹‰å–ä»“åº“ä»£ç 
      uses: actions/checkout@v4
      with:
        ref: main

    - name: ğŸ”„ åŒæ­¥æœ€æ–°ä»£ç 
      run: |
        git fetch --prune
        git reset --hard origin/main

    - name: ğŸ é…ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ğŸ“¦ å®‰è£…Pythonä¾èµ–
      run: |
        pip install --upgrade pip
        pip install pyyaml

    - name: ğŸš€ æ‰§è¡ŒFreeTVè„šæœ¬
      run: |
        python scripts/freetv/freetv.py

    - name: ğŸ” éªŒè¯è¾“å‡ºæ–‡ä»¶
      run: |
        # ç›´æ¥åˆ—å‡ºæ–‡ä»¶ï¼Œé¿å…å¤æ‚çš„å¤šè¡Œå­—ç¬¦ä¸²
        files="output/freetv/complete.m3u output/freetv/complete.txt output/freetv/cctv_only.m3u output/freetv/cctv_only.txt output/freetv/satellite.m3u output/freetv/satellite.txt output/freetv/others.m3u output/freetv/others.txt"
        
        for file in $files; do
          if [ ! -f "$file" ]; then
            echo "âŒ é”™è¯¯ï¼šè¾“å‡ºæ–‡ä»¶ $file æœªç”Ÿæˆ"
            exit 1
          fi
          echo "âœ… æ–‡ä»¶ $file å·²æˆåŠŸç”Ÿæˆ"
        done

    - name: ğŸ’¾ ä¸Šä¼ ç”Ÿæˆæ–‡ä»¶åˆ¶å“
      uses: actions/upload-artifact@v4
      with:
        name: freetv-output
        path: |
          output/freetv/complete.m3u
          output/freetv/complete.txt
          output/freetv/cctv_only.m3u
          output/freetv/cctv_only.txt
          output/freetv/satellite.m3u
          output/freetv/satellite.txt
          output/freetv/others.m3u
          output/freetv/others.txt

    - name: ğŸ—‘ï¸ æ¸…ç†è¿‡æœŸå†å²å½’æ¡£
      run: |
        mkdir -p ${{ env.HISTORY_DIR }}
        # æ¸…ç†3å¤©å‰çš„å½’æ¡£
        find ${{ env.HISTORY_DIR }} -name "*.zip" -type f -mtime +3 -delete
        echo "âœ… è¿‡æœŸå½’æ¡£æ¸…ç†å®Œæˆ"

    - name: ğŸ” æ£€æµ‹æ–‡ä»¶å˜æ›´
      id: check_changes
      run: |
        git add .
        if git diff --staged --quiet; then
          echo "changes_detected=false" >> $GITHUB_OUTPUT
          echo "ğŸŸ¡ æœªæ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
        else
          echo "changes_detected=true" >> $GITHUB_OUTPUT
          echo "ğŸŸ¢ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
        fi

    - name: ğŸ“¦ åˆ›å»ºæœ¬æ¬¡å˜æ›´å½’æ¡£
      if: steps.check_changes.outputs.changes_detected == 'true'
      run: |
        mkdir -p ${{ env.HISTORY_DIR }}
        current_datetime=$(date +'%Y%m%d_%H%M%S')
        zip_filename="${{ env.HISTORY_DIR }}/${current_datetime}_freetv.zip"
        
        # ç›´æ¥åˆ—å‡ºè¦å½’æ¡£çš„æ–‡ä»¶
        zip -j "$zip_filename" \
          output/freetv/complete.m3u \
          output/freetv/complete.txt \
          output/freetv/cctv_only.m3u \
          output/freetv/cctv_only.txt \
          output/freetv/satellite.m3u \
          output/freetv/satellite.txt \
          output/freetv/others.m3u \
          output/freetv/others.txt
        
        echo "âœ… åˆ›å»ºå½’æ¡£: $zip_filename"

    - name: ğŸ’¾ æäº¤å˜æ›´åˆ°ä»“åº“
      if: steps.check_changes.outputs.changes_detected == 'true'
      run: |
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        git add output/freetv/ ${{ env.HISTORY_DIR }}/
        commit_time=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
        git commit -m "ğŸ“º FreeTVé¢‘é“æ›´æ–° $commit_time"
        git push origin main
        echo "ğŸ‰ FreeTVé¢‘é“åˆ—è¡¨æ›´æ–°å®Œæˆï¼"
