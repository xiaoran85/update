name: To AcWing â˜ repository force âœ” 

# è§¦å‘æ¡ä»¶é…ç½®
on:
  # å®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©UTCæ—¶é—´22:25è§¦å‘ï¼ˆåŒ—äº¬æ—¶é—´æ¬¡æ—¥æ—©ä¸Š6:25ï¼‰
  #schedule:
    #- cron: '25 22 * * *'
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼Œå¹¶å¯è‡ªå®šä¹‰ç›®æ ‡ä»“åº“å
  workflow_dispatch:
    inputs:
      target_repo_name:
        description: 'ç›®æ ‡ä»“åº“åï¼ˆé»˜è®¤sourceï¼‰'
        required: false
        default: 'source'

jobs:
  # åŒæ­¥ä»“åº“ä»»åŠ¡
  sync-repository:
    runs-on: ubuntu-latest  # ä½¿ç”¨æœ€æ–°çš„Ubuntuç¯å¢ƒ
    timeout-minutes: 30     # è®¾ç½®æœ€å¤§è¶…æ—¶æ—¶é—´ä¸º30åˆ†é’Ÿ

    env:
      # ä»GitHub Secretsæ³¨å…¥AcWingè´¦å·å¯†ç 
      ACWING_USERNAME: ${{ secrets.ACWING_USERNAME }}
      ACWING_PASSWORD: ${{ secrets.ACWING_PASSWORD }}
      TZ: Asia/Shanghai      # è®¾ç½®æ—¶åŒºä¸ºåŒ—äº¬æ—¶é—´ï¼Œæ–¹ä¾¿æ—¶é—´æˆ³æ˜¾ç¤º
      TARGET_REPO: ${{ github.event.inputs.target_repo_name || 'source' }}

    steps:
      # 1. æ£€å‡ºæ•´ä¸ªæºä»“åº“ä»£ç ï¼ˆå«å®Œæ•´å†å²ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0       # æ‹‰å–å®Œæ•´å†å²ï¼Œä¸ä»…æœ€æ–°æäº¤
          path: source-repo    # æ£€å‡ºåˆ°source-repoæ–‡ä»¶å¤¹

      # 2. é…ç½®Gitå…¨å±€ç”¨æˆ·ä¿¡æ¯å’Œæ ¸å¿ƒè®¾ç½®
      - name: Configure Git
        run: |
          git config --global user.name "xiaoran67"
          git config --global user.email "327530006@qq.com"
          git config --global init.defaultBranch main    # é»˜è®¤åˆ†æ”¯åä¸ºmain
          git config --global core.autocrlf false        # ç¦æ­¢è‡ªåŠ¨è½¬æ¢æ¢è¡Œç¬¦ï¼Œé¿å…Windows/Linuxå·®å¼‚
          git config --global core.safecrlf false

      # 3. éªŒè¯AcWingè´¦å·å¯†ç æ˜¯å¦é…ç½®ï¼Œç¼ºå°‘åˆ™ç»ˆæ­¢æµç¨‹
      - name: Verify credentials
        run: |
          if [ -z "$ACWING_USERNAME" ]; then
            echo "::error::ACWING_USERNAME æœªé…ç½®"
            exit 1
          fi
          
          if [ -z "$ACWING_PASSWORD" ]; then
            echo "::error::ACWING_PASSWORD æœªé…ç½®"
            exit 1
          fi
          
          echo "éªŒè¯é€šè¿‡ï¼šç”¨æˆ·å $ACWING_USERNAME"

      # 4. å‡†å¤‡AcWingåŒæ­¥ä»“åº“
      - name: Prepare AcWing repository
        run: |
          mkdir -p acwing-sync && cd acwing-sync   # åˆ›å»ºå¹¶è¿›å…¥å·¥ä½œç›®å½•
          git init -q                             # åˆå§‹åŒ–ç©ºä»“åº“ï¼ˆé™é»˜æ¨¡å¼ï¼‰
          # è®¾ç½®è¿œç¨‹åœ°å€ï¼Œå¸¦è´¦å·å¯†ç ç”¨äºè®¤è¯ï¼Œä»“åº“åä½¿ç”¨è‡ªå®šä¹‰å˜é‡
          git remote add origin https://$ACWING_USERNAME:$ACWING_PASSWORD@git.acwing.com/xiaoran67/${TARGET_REPO}.git
          
          # å°è¯•æ‹‰å–è¿œç¨‹mainåˆ†æ”¯ï¼Œåˆ¤æ–­ä»“åº“æ˜¯å¦å·²æœ‰å†…å®¹
          if git fetch origin main --depth=1 2>/dev/null; then
            echo "æ‰¾åˆ°ç°æœ‰ä»“åº“ï¼Œæ£€å‡ºmainåˆ†æ”¯"
            git checkout -B main origin/main      # åˆ‡æ¢æˆ–åˆ›å»ºæœ¬åœ°mainåˆ†æ”¯ï¼Œè·Ÿè¸ªè¿œç¨‹main
          else
            echo "åˆ›å»ºæ–°çš„mainåˆ†æ”¯"
            git checkout -b main                  # æ–°å»ºmainåˆ†æ”¯
            # ç©ºä»“åº“æ—¶æ·»åŠ READMEï¼Œé¿å…ç©ºä»“åº“æ— æ³•æäº¤
            echo "# $ACWING_USERNAME çš„åŒæ­¥ä»“åº“" > README.md
            git add README.md
            git commit -m "åˆå§‹æäº¤"
          fi

      # 5. åŒæ­¥æ–‡ä»¶å†…å®¹ï¼ˆä¿æŒç›®æ ‡ä»“åº“ä¸æºä»“åº“ä¸€è‡´ï¼‰
      - name: Sync entire repository
        run: |
          cd acwing-sync
          
          # å¤‡ä»½.gitç›®å½•ï¼Œé˜²æ­¢è¢«è¦†ç›–ä¸¢å¤±å†å²
          cp -r .git ../.git-backup
          
          # æ¸…ç©ºå½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼Œä¿ç•™.gitç›®å½•
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +
          
          # å¤åˆ¶æºä»“åº“å†…å®¹åˆ°å½“å‰ç›®å½•ï¼ˆä¸åŒ…å«.gitï¼‰
          cp -r ../source-repo/* .
          
          # æ¢å¤.gitç›®å½•ï¼Œä¿è¯gitç‰ˆæœ¬ä¿¡æ¯å®Œæ•´
          rm -rf .git
          mv ../.git-backup .git
          
          # æ·»åŠ æ‰€æœ‰å˜æ›´ï¼ˆæ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤ï¼‰
          git add -A
          
          # åˆ¤æ–­æ˜¯å¦æœ‰å˜æ›´ï¼Œé¿å…æ— æ„ä¹‰æäº¤
          if git diff-index --quiet HEAD --; then
            echo "æ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            # æäº¤å˜æ›´ï¼Œæäº¤ä¿¡æ¯å¸¦åŒ—äº¬æ—¶é—´æ—¶é—´æˆ³
            git commit -m "ğŸ”„ $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
            
            # å¼ºåˆ¶æ¨é€åˆ°è¿œç¨‹mainåˆ†æ”¯ï¼Œè¦†ç›–ç›®æ ‡ä»“åº“å†…å®¹
            git push -u origin main --force
            echo "åŒæ­¥æˆåŠŸå®Œæˆ"
          fi

      # 6. æ¸…ç†ä¸´æ—¶ç›®å½•
      - name: Cleanup
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¼šæ‰§è¡Œ
        run: |
          rm -rf acwing-sync .git-backup
