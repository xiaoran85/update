name: Update special â˜ âœ”ï¸ 

on:
  schedule:
    - cron: '30 20 * * *'  # UTCæ—¶é—´æ¯å¤©22ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´æ¬¡æ—¥4ç‚¹30åˆ†ï¼‰æ‰§è¡Œ
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write         # å…è®¸æ¨é€ä»£ç åˆ°ä»“åº“

jobs:
  update:
    runs-on: ubuntu-latest
    name: æ•´ç†å¹¶æ›´æ–°ç‰¹æ®Šç›´æ’­æº

    steps:
      - name: ğŸ“¦ æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: å¼ºåˆ¶åŒæ­¥è¿œç¨‹ä»£ç 
        run: git fetch --prune && git reset --hard origin/main

      - name: ğŸ è®¾ç½® Python 3.10 ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ”§ å®‰è£…ä¾èµ–ï¼ˆå†…ç½®urllibï¼Œæ— éœ€é¢å¤–åŒ…ï¼‰
        run: python -m pip install --upgrade pip

      - name: â–¶ï¸ æ‰§è¡Œç›´æ’­æºæ•´ç†è„šæœ¬
        run: python assets/special/special.py  # ä»ä»“åº“æ ¹ç›®å½•è¿è¡Œè„šæœ¬

      - name: ğŸ“‹ éªŒè¯è¾“å‡ºç»“æœ
        run: |
          echo "è¾“å‡ºæ–‡ä»¶å†…å®¹æ£€æŸ¥ï¼š"
          if [ -f "output/special/live_special.txt" ]; then
            echo "æ–‡ä»¶å­˜åœ¨ï¼Œå†…å®¹è¡Œæ•°ï¼š$(cat output/special/live_special.txt | wc -l)"
            echo "å‰5è¡Œé¢„è§ˆï¼š"
            head -n 5 output/special/live_special.txt
          else
            echo "é”™è¯¯ï¼šæœªç”Ÿæˆ output/special/live_special.txt"
            exit 1
          fi

      - name: ğŸ“¦ æ‰“åŒ…è¾“å‡ºæ–‡ä»¶åˆ°å†å²è®°å½•ï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰
        run: |
          # åˆ›å»ºå†å²è®°å½•ç›®å½•
          mkdir -p history/special
          # ç”Ÿæˆå¸¦æ—¥æœŸæ—¶é—´ï¼ˆç²¾ç¡®åˆ°ç§’ï¼‰çš„æ–‡ä»¶åï¼ˆæ ¼å¼ï¼šYYYYMMDD_HHMMSS_live_special.zipï¼‰
          zip_filename="$(date +%Y%m%d_%H%M%S)_live_special.zip"
          # æ‰“åŒ…è¾“å‡ºæ–‡ä»¶
          zip -j history/special/$zip_filename output/special/live_special.txt
          echo "å·²ç”Ÿæˆå†å²åŒ…ï¼šhistory/special/$zip_filename"

      - name: ğŸ§¹ æ¸…ç†7å¤©å‰çš„å†å²æ–‡ä»¶
        run: |
          # ä¿ç•™æœ€è¿‘7å¤©çš„æ–‡ä»¶ï¼Œåˆ é™¤æ›´æ—©çš„å†å²åŒ…
          find history/special -name "*.zip" -type f -mtime +7 -delete
          echo "å·²æ¸…ç†7å¤©å‰çš„å†å²æ‰“åŒ…æ–‡ä»¶"

      - name: ğŸ’¾ æäº¤å¹¶æ¨é€å˜æ›´
        run: |
          git config --local user.email "bot@github.com"
          git config --local user.name "Stable Bot"
          # è·Ÿè¸ªæ‰€æœ‰ç›¸å…³æ–‡ä»¶å’Œç›®å½•
          git add \
            assets/special/special.py \
            assets/special/urls.txt \
            assets/special/ExcludeList.txt \
            assets/special/rename.txt \
            output/special/ \
            history/special/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "âš ï¸ æ— æ›´æ–°å†…å®¹ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          git commit -m "ğŸŒ¾ $(date +'%Y-%m-%d %H:%M:%S')"
          # å¤„ç†å†²çªå¹¶æ¨é€
          git pull origin main --rebase --autostash || {
            echo "å˜åŸºå†²çªï¼Œè‡ªåŠ¨ç”¨è¿œç¨‹æœ€æ–°ä»£ç è¦†ç›–æœ¬åœ°";
            git rebase --abort;
            git pull origin main --force;
          }
          git push origin main --force-with-lease || git push --force origin main
