name: Sync Entire Repo to GitCode âœ”

on:
  # UTC æ—¶é—´22:05è§¦å‘ï¼ŒåŒ—äº¬æ—¶é—´æ¬¡æ—¥6:05
  schedule:
    - cron: '5 22 * * *'
  workflow_dispatch:
    inputs:
      target-repo:
        description: 'GitCode ä»“åº“å'
        required: false
        default: 'update'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºæºä»“åº“ï¼ˆå®Œæ•´å…‹éš† GitHub æºä»“åº“ï¼‰
      - name: Checkout Full Source Repo
        uses: actions/checkout@v4
        with:
          path: src
          fetch-depth: 0  # å®Œæ•´å…‹éš†æ‰€æœ‰å†å²

      # 2. å…‹éš†ç›®æ ‡ä»“åº“ï¼ˆGitCode å®Œæ•´ä»“åº“ï¼‰
      - name: Clone Full Target Repo
        run: |
          GITCODE_USER="xiaoran79"
          GITCODE_REPO="${{ inputs.target-repo || 'update' }}"
          git clone \
            "https://${GITCODE_USER}:${{ secrets.GITCODE_ACCESS_TOKEN }}@gitcode.com/${GITCODE_USER}/${GITCODE_REPO}.git" \
            target

      # 3. å…¨é‡åŒæ­¥ï¼šè¦†ç›–ç›®æ ‡ä»“åº“ï¼ˆä¿ç•™ .git ç›®å½•ï¼‰
      - name: Full Repo Sync
        run: |
          # æ¸…ç©ºç›®æ ‡ä»“åº“å†…å®¹ï¼ˆé™¤ .git ç›®å½•å¤–ï¼‰
          cd target
          find . -maxdepth 1 ! -name ".git" ! -name "." -exec rm -rf {} +
          # å¤åˆ¶æºä»“åº“æ‰€æœ‰å†…å®¹åˆ°ç›®æ ‡ä»“åº“
          cp -r ../src/* .
          cp -r ../src/.* .  # å¤åˆ¶éšè—æ–‡ä»¶

      # 4. æ£€æŸ¥ç›®æ ‡ä»“åº“æ˜¯å¦æœ‰å˜åŒ–
      - name: Check Changes
        id: check_changes
        run: |
          cd target
          git status --porcelain
          if [ -n "$(git status --porcelain)" ]; then
            echo "CHANGES_DETECTED=true" >> $GITHUB_ENV
          else
            echo "CHANGES_DETECTED=false" >> $GITHUB_ENV
          fi

      # 5. æäº¤å¹¶æ¨é€å…¨é‡æ›´æ–°
      - name: Commit and Push Full Repo
        if: env.CHANGES_DETECTED == 'true'
        run: |
          cd target
          git config user.name "Auto Sync Bot"
          git config user.email "auto-sync@noreply.github.com"
          git add -A
          git commit -m "ğŸ”„ Full repo sync: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          git push origin HEAD --force  # å…¨é‡åŒæ­¥å»ºè®®å¼ºåˆ¶æ¨é€

      # 6. è¾“å‡ºåŒæ­¥ç»“æœ
      - name: Sync Report
        run: |
          if [ "$CHANGES_DETECTED" = "true" ]; then
            echo "âœ… å·²å®Œæˆ GitHub åˆ° GitCode çš„å…¨ä»“åº“åŒæ­¥å¹¶æ¨é€"
          else
            echo "â„¹ï¸ æ— éœ€åŒæ­¥ï¼šGitHub æºä¸ GitCode ç›®æ ‡ä»“åº“å†…å®¹å®Œå…¨ä¸€è‡´"
          fi
