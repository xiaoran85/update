name: æ•´ç†æœ¬åœ°æº â˜ streaming
on:
  # è‡ªåŠ¨å®šæ—¶æ›´æ–°
  schedule:
    - cron: '50 20 1 1 *'  # æ¯å¹´è¿è¡Œä¸€æ¬¡
  # æ‰‹åŠ¨è§¦å‘æ›´æ–°ï¼ˆç‚¹å‡»å³è¿è¡Œï¼‰
  workflow_dispatch:

jobs:
  force-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å¿…é¡»æœ‰å†™æƒé™

    steps:
    - name: æ‹‰å–ä»“åº“ä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # æ‹‰å–å®Œæ•´å†å²ï¼Œé¿å…å†²çª

    # æ–°å¢ï¼šå¼ºåˆ¶åŒæ­¥è¿œç¨‹ä»£ç ï¼ˆåº”å¯¹ä»“åº“é‡å»ºï¼‰
    - name: å¼ºåˆ¶åŒæ­¥è¿œç¨‹ä»£ç 
      run: git fetch --prune && git reset --hard origin/${{ github.ref_name }}

    - name: å®‰è£…Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: å‡†å¤‡ç›®å½•ï¼ˆç¡®ä¿ä¾èµ–æ–‡ä»¶å­˜åœ¨ï¼‰
      run: |
        mkdir -p assets/streaming
        touch assets/streaming/sources.txt 
        touch assets/streaming/rename.txt 

    - name: è¿è¡Œè„šæœ¬ï¼ˆå¼ºåˆ¶ç”Ÿæˆæ–°å†…å®¹ï¼‰
      run: python3 assets/streaming/streaming.py  # è„šæœ¬ä¼šè¾“å‡ºåˆ°åŒç›®å½•

    - name: å¼ºåˆ¶æ¨é€ï¼ˆæ‰‹åŠ¨/è‡ªåŠ¨è§¦å‘å‡ç”Ÿæ•ˆï¼‰
      run: |
        git config user.email "action@github.com"
        git config user.name "GitHub Action Bot"
        git add assets/streaming/  # åªæäº¤ assets/streaming/ ç›®å½•çš„å˜åŒ–
        git commit -m "${{ github.event_name == 'workflow_dispatch' && 'ğŸŒ´' || ':hot_pepper:' }} $(date '+%Y-%m-%d %H:%M:%S')" || git commit --allow-empty -m "æ— å†…å®¹å˜æ›´ä½†å¼ºåˆ¶æäº¤"
        # ä¼˜åŒ–æ‹‰å–é€»è¾‘ï¼Œæ·»åŠ å†²çªå¤„ç†
        git pull origin ${{ github.ref_name }} --rebase --autostash || {
          echo "å˜åŸºå†²çªï¼Œè‡ªåŠ¨ç”¨è¿œç¨‹æœ€æ–°ä»£ç è¦†ç›–æœ¬åœ°";
          git rebase --abort;
          git pull origin ${{ github.ref_name }} --force;
        }
        git push origin ${{ github.ref_name }} --force-with-lease || git push origin ${{ github.ref_name }} --force  # ä¼˜åŒ–æ¨é€é€»è¾‘
