name: To AcWing â˜ folder incremental âœ”

on:
  schedule:
    - cron: '15 22 * * *'  
  workflow_dispatch:
    inputs:
      source-folder:
        description: 'æºæ–‡ä»¶å¤¹'
        required: false
        default: 'output'
      target-repo:
        description: 'AcWing ä»“åº“å'
        required: false
        default: 'source'
      target-subdir:
        description: 'AcWing å­ç›®å½•'
        required: false
        default: 'output'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºæºä»“åº“ï¼ˆGitHub ä»£ç ï¼‰
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          path: src  # ä»£ç æ£€å‡ºåˆ° src ç›®å½•

      # 2. å…‹éš†ç›®æ ‡ä»“åº“ï¼ˆAcWing Git ä»“åº“ï¼‰
      - name: Clone Target
        run: |
          # æ‹¼æ¥ AcWing ä»“åº“åœ°å€ï¼Œä½¿ç”¨ secrets å­˜å‚¨çš„è´¦å·å¯†ç è®¤è¯
          git clone --depth=1 \
            "https://${{ secrets.ACWING_USERNAME }}:${{ secrets.ACWING_PASSWORD }}@git.acwing.com/xiaoran67/${{ inputs.target-repo || 'source' }}.git" \
            target

      # 3. è®¡ç®—æºæ–‡ä»¶å¤¹å“ˆå¸Œ
      - name: Hash Source
        id: hash_src
        run: |
          cd src
          # åŸºäºæºæ–‡ä»¶å¤¹è®¡ç®—å“ˆå¸Œï¼Œç”¨äºå¯¹æ¯”å†…å®¹æ˜¯å¦å˜åŒ–
          SRC_HASH=$(find "${{ inputs.source-folder || 'output' }}" -type f -exec sha1sum {} + | sort | sha1sum | awk '{print $1}')
          echo "SRC_HASH=$SRC_HASH" >> $GITHUB_ENV

      # 4. è®¡ç®—ç›®æ ‡æ–‡ä»¶å¤¹å“ˆå¸Œ
      - name: Hash Target
        id: hash_tgt
        run: |
          cd target
          # åŸºäºç›®æ ‡ä»“åº“é‡Œçš„å­ç›®å½•è®¡ç®—å“ˆå¸Œ
          TGT_HASH=$(find "${{ inputs.target-subdir || 'output' }}" -type f -exec sha1sum {} + 2>/dev/null | sort | sha1sum | awk '{print $1}')
          # è‹¥ç›®æ ‡ç›®å½•ä¸å­˜åœ¨ï¼Œå“ˆå¸Œè®¾ä¸ºå…¨ 0
          if [ -z "$TGT_HASH" ]; then
            TGT_HASH="0000000000000000000000000000000000000000"
          fi
          echo "TGT_HASH=$TGT_HASH" >> $GITHUB_ENV

      # 5. æ¯”è¾ƒå“ˆå¸Œï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦åŒæ­¥
      - name: Compare Hashes
        run: |
          echo "æºæ–‡ä»¶å¤¹å“ˆå¸Œ: ${{ env.SRC_HASH }}"
          echo "ç›®æ ‡æ–‡ä»¶å¤¹å“ˆå¸Œ: ${{ env.TGT_HASH }}"
          if [ "${{ env.SRC_HASH }}" = "${{ env.TGT_HASH }}" ]; then
            echo "âœ… å†…å®¹ä¸€è‡´ï¼Œè·³è¿‡åŒæ­¥"
            echo "SYNC_NEEDED=false" >> $GITHUB_ENV
          else
            echo "ğŸ”„ å†…å®¹ä¸ä¸€è‡´ï¼Œæ‰§è¡Œå¢é‡åŒæ­¥"
            echo "SYNC_NEEDED=true" >> $GITHUB_ENV
          fi

      # 6. å¢é‡åŒæ­¥ï¼ˆä½¿ç”¨ rsync åŒæ­¥å·®å¼‚å†…å®¹ï¼‰
      - name: Incremental Sync
        if: env.SYNC_NEEDED == 'true'
        run: |
          rsync -av --delete "src/${{ inputs.source-folder || 'output' }}/" "target/${{ inputs.target-subdir || 'output' }}/"

      # 7. æ£€æŸ¥ç›®æ ‡ä»“åº“ï¼ˆAcWingï¼‰æ˜¯å¦æœ‰å˜åŒ–
      - name: Check Changes in Target
        if: env.SYNC_NEEDED == 'true'
        id: check_changes
        run: |
          cd target
          # æŸ¥çœ‹ Git å·¥ä½œåŒºçŠ¶æ€
          git status --porcelain
          if [ -n "$(git status --porcelain)" ]; then
            echo "CHANGES_DETECTED=true" >> $GITHUB_ENV
          else
            echo "CHANGES_DETECTED=false" >> $GITHUB_ENV
          fi

      # 8. æäº¤å¹¶æ¨é€åˆ° AcWing ä»“åº“ï¼ˆä»…æ£€æµ‹åˆ°å˜åŒ–æ—¶ï¼‰
      - name: Commit and Push to AcWing
        if: env.SYNC_NEEDED == 'true' && env.CHANGES_DETECTED == 'true'
        run: |
          cd target
          # é…ç½® Git æäº¤èº«ä»½
          git config user.name "Auto Sync"
          git config user.email "sync@noreply"
          # æš‚å­˜æ‰€æœ‰å˜åŒ–
          git add -A
          # ç”Ÿæˆå¸¦åŒ—äº¬æ—¶é—´çš„æäº¤ä¿¡æ¯
          git commit -m "ğŸ”„ $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          # æ¨é€åˆ° AcWing ä»“åº“
          git push origin HEAD

      # 9. åŒæ­¥ç»“æœæŠ¥å‘Š
      - name: Sync Report
        run: |
          if [ "$SYNC_NEEDED" = "true" ]; then
            if [ "$CHANGES_DETECTED" = "true" ]; then
              echo "âœ… å·²å®Œæˆå¢é‡åŒæ­¥å¹¶æ¨é€æ›´æ–°åˆ° AcWing ä»“åº“"
            else
              echo "â„¹ï¸ å¢é‡åŒæ­¥æ‰§è¡Œï¼Œä½†æœªæ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼ˆå¯èƒ½å“ˆå¸Œå†²çªæˆ–æ–‡ä»¶æ— å®é™…æ”¹åŠ¨ï¼‰"
            fi
          else
            echo "â„¹ï¸ æºä¸ AcWing ç›®æ ‡å†…å®¹ä¸€è‡´ï¼Œæ— éœ€åŒæ­¥"
          fi
