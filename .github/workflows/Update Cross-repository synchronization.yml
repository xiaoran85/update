name: è·¨ä»“åº“åŒæ­¥ï¼ˆå¢é‡+è¦†ç›–ï¼‰
# Cross-repository synchronization

on:
  workflow_dispatch:
    inputs:
      source:
        description: 'æºä»“åº“ä¿¡æ¯ï¼ˆç”¨æˆ·/ä»“åº“å@åˆ†æ”¯ï¼‰'
        type: string
        required: true
        default: 'xiaoran67/update@main'
      source_folder:
        description: 'æºä»“åº“åŒæ­¥è·¯å¾„ï¼ˆç•™ç©º=æ ¹ç›®å½•ï¼‰'
        type: string
        required: false
        default: ''
      source_token_name:
        description: 'æºä»“åº“Tokençš„Secretåç§°'
        type: string
        required: false
        default: 'CUSTOM67_GITHUB_TOKEN'
      
      target:
        description: 'ç›®æ ‡ä»“åº“ä¿¡æ¯ï¼ˆç”¨æˆ·/ä»“åº“å@åˆ†æ”¯ï¼‰'
        type: string
        required: true
        default: 'xiaoran67/update001@main'
      target_folder:
        description: 'ç›®æ ‡ä»“åº“æ¥æ”¶è·¯å¾„ï¼ˆç•™ç©º=æ ¹ç›®å½•ï¼‰'
        type: string
        required: false
        default: ''
      target_private:
        description: 'ç›®æ ‡ä»“åº“æ˜¯å¦ç§æœ‰'
        type: boolean
        required: true
        default: false
      target_token_name:
        description: 'ç›®æ ‡ä»“åº“Tokençš„Secretåç§°'
        type: string
        required: false
        default: 'CUSTOM67_GITHUB_TOKEN'
      
      sync_strategy:
        description: 'åŒæ­¥ç­–ç•¥'
        type: choice
        required: true
        options:
          - 'å¢é‡'
          - 'è¦†ç›–'
        default: 'å¢é‡'
      commit_template:
        description: 'æäº¤ä¿¡æ¯æ¨¡æ¿'
        type: choice
        required: true
        options:
          - 'ä»…æ—¶é—´'     # é»˜è®¤é€‰é¡¹
          - 'åŒæ­¥è¯´æ˜'
          - 'è‡ªå®šä¹‰'
        default: 'ä»…æ—¶é—´'
      custom_commit_msg:
        description: 'è‡ªå®šä¹‰æäº¤ä¿¡æ¯ï¼ˆé€‰â€œè‡ªå®šä¹‰â€æ—¶å¡«å†™ï¼‰'
        type: string
        required: false
        default: ''

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 1. è§£æé…ç½®ä¿¡æ¯ï¼ˆå¢å¼ºæ ¼å¼æ ¡éªŒï¼‰
      - name: ğŸ§© è§£æé…ç½®ä¿¡æ¯
        id: parse_config
        run: |
          # è§£ææºä»“åº“ï¼ˆä¸¥æ ¼æ ¡éªŒæ ¼å¼ï¼‰
          if ! echo "${INPUT_SOURCE}" | grep -qE '^[a-zA-Z0-9-]+/[a-zA-Z0-9-]+@[a-zA-Z0-9-]+$'; then
            echo "é”™è¯¯ï¼šæºä»“åº“æ ¼å¼åº”ä¸º ç”¨æˆ·å/ä»“åº“å@åˆ†æ”¯" && exit 1
          fi
          IFS='/@' read -r source_user source_repo source_branch <<< "${INPUT_SOURCE}"
          echo "source_user=${source_user}" >> $GITHUB_ENV
          echo "source_repo=${source_repo}" >> $GITHUB_ENV
          echo "source_branch=${source_branch}" >> $GITHUB_ENV
          
          # è§£æç›®æ ‡ä»“åº“ï¼ˆä¸¥æ ¼æ ¡éªŒæ ¼å¼ï¼‰
          if ! echo "${INPUT_TARGET}" | grep -qE '^[a-zA-Z0-9-]+/[a-zA-Z0-9-]+@[a-zA-Z0-9-]+$'; then
            echo "é”™è¯¯ï¼šç›®æ ‡ä»“åº“æ ¼å¼åº”ä¸º ç”¨æˆ·å/ä»“åº“å@åˆ†æ”¯" && exit 1
          fi
          IFS='/@' read -r target_user target_repo target_branch <<< "${INPUT_TARGET}"
          echo "target_user=${target_user}" >> $GITHUB_ENV
          echo "target_repo=${target_repo}" >> $GITHUB_ENV
          echo "target_branch=${target_branch}" >> $GITHUB_ENV
          
          echo "source_token_name=${INPUT_SOURCE_TOKEN_NAME}" >> $GITHUB_ENV
          echo "target_token_name=${INPUT_TARGET_TOKEN_NAME}" >> $GITHUB_ENV
        env:
          INPUT_SOURCE: ${{ inputs.source }}
          INPUT_TARGET: ${{ inputs.target }}
          INPUT_SOURCE_TOKEN_NAME: ${{ inputs.source_token_name }}
          INPUT_TARGET_TOKEN_NAME: ${{ inputs.target_token_name }}

      # 2. æ ¡éªŒTokenå­˜åœ¨æ€§
      - name: ğŸ”‘ æ ¡éªŒToken
        run: |
          # æ ¡éªŒæºToken
          if [ -z "${{ secrets[inputs.source_token_name] }}" ]; then
            echo "é”™è¯¯ï¼šæºä»“åº“Tokenï¼ˆ${{ inputs.source_token_name }}ï¼‰ä¸å­˜åœ¨" && exit 1
          fi
          # æ ¡éªŒç›®æ ‡Token
          if [ -z "${{ secrets[inputs.target_token_name] }}" ]; then
            echo "é”™è¯¯ï¼šç›®æ ‡ä»“åº“Tokenï¼ˆ${{ inputs.target_token_name }}ï¼‰ä¸å­˜åœ¨" && exit 1
          fi

      # 3. æ£€å‡ºæºä»“åº“
      - name: ğŸ“¥ æ£€å‡ºæºä»“åº“
        uses: actions/checkout@v4
        with:
          repository: ${{ env.source_user }}/${{ env.source_repo }}
          ref: ${{ env.source_branch }}
          path: source_repo
          token: ${{ secrets[inputs.source_token_name] }}
          fetch-depth: 0
          clean: true

      # 4. å®‰è£…ä¾èµ–ï¼ˆå«jqï¼‰
      - name: ğŸ› ï¸ å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update && sudo apt-get install -y rsync jq

      # 5. å¤„ç†ç›®æ ‡ä»“åº“ï¼ˆä¼˜åŒ–è¦†ç›–åŒæ­¥é€»è¾‘ï¼Œé¿å…åˆ é™¤ä»“åº“ï¼‰
      - name: ğŸ”¹ å¢é‡åŒæ­¥ - å…‹éš†ç›®æ ‡ä»“åº“
        if: ${{ inputs.sync_strategy == 'å¢é‡' }}
        run: |
          TARGET_TOKEN="${{ secrets[env.target_token_name] }}"
          git clone --depth=1 --branch ${{ env.target_branch }} "https://$TARGET_TOKEN@github.com/${{ env.target_user }}/${{ env.target_repo }}.git" target_repo
          # æ‹‰å–æœ€æ–°ä»£ç ï¼ˆé¿å…å†²çªï¼‰
          cd target_repo && git pull origin ${{ env.target_branch }} && cd ..
          # åˆ›å»ºç›®æ ‡è·¯å¾„
          mkdir -p "target_repo/${{ inputs.target_folder }}"

      - name: ğŸ”¹ è¦†ç›–åŒæ­¥ - æ¸…ç©ºä»“åº“ï¼ˆæ›¿ä»£åˆ é™¤é‡å»ºï¼‰
        if: ${{ inputs.sync_strategy == 'è¦†ç›–' }}
        run: |
          TARGET_TOKEN="${{ secrets[env.target_token_name] }}"
          # å…‹éš†ç›®æ ‡ä»“åº“
          git clone --depth=1 --branch ${{ env.target_branch }} "https://$TARGET_TOKEN@github.com/${{ env.target_user }}/${{ env.target_repo }}.git" target_repo
          cd target_repo
          # æ¸…ç©ºä»“åº“å†…å®¹ï¼ˆä¿ç•™.gitç›®å½•ï¼‰
          git rm -rf .
          git commit -m "ğŸ”„ è¦†ç›–åŒæ­¥ï¼šæ¸…ç©ºå†å²å†…å®¹" || echo "ä»“åº“å·²ç©º"
          git push --force
          cd ..
          # åˆ›å»ºç›®æ ‡è·¯å¾„
          mkdir -p "target_repo/${{ inputs.target_folder }}"

      # 6. æ‰§è¡ŒåŒæ­¥ï¼ˆå¢å¼ºè·¯å¾„æ ¡éªŒï¼‰
      - name: ğŸš€ æ‰§è¡ŒåŒæ­¥
        run: |
          # æ ¡éªŒæºè·¯å¾„
          SOURCE_PATH="source_repo/${{ inputs.source_folder }}"
          [ -z "${{ inputs.source_folder }}" ] && SOURCE_PATH="source_repo"
          if [ ! -d "$SOURCE_PATH" ]; then
            echo "é”™è¯¯ï¼šæºè·¯å¾„ ${SOURCE_PATH} ä¸å­˜åœ¨" && exit 1
          fi
          
          # ç›®æ ‡è·¯å¾„
          TARGET_PATH="target_repo/${{ inputs.target_folder }}"
          [ -z "${{ inputs.target_folder }}" ] && TARGET_PATH="target_repo"
          mkdir -p "$TARGET_PATH"
          
          # æ‰§è¡ŒåŒæ­¥
          if [ "${{ inputs.sync_strategy }}" = "å¢é‡" ]; then
            rsync -av --ignore-existing --exclude=".git/" "${SOURCE_PATH}/" "${TARGET_PATH}/"
          else
            rsync -av --delete --force --exclude=".git/" "${SOURCE_PATH}/" "${TARGET_PATH}/"
          fi

      # 7. æ£€æµ‹å˜åŒ–ï¼ˆé¿å…æ— æ„ä¹‰æäº¤ï¼‰
      - name: ğŸ§ æ£€æµ‹ç›®æ ‡ä»“åº“å˜åŒ–
        run: |
          cd target_repo
          # æ’é™¤.gitç›®å½•ï¼Œä¸¥æ ¼æ£€æŸ¥å®é™…æ–‡ä»¶å˜æ›´
          if git status --porcelain | grep -v '^??' | grep -q .; then
            echo "CHANGES_DETECTED=true" >> $GITHUB_ENV
          else
            echo "CHANGES_DETECTED=false" >> $GITHUB_ENV
          fi

      # 8. æ¨é€æ›´æ–°ï¼ˆå¢å¼ºå®¹é”™ï¼‰
      - name: ğŸ“¤ æ¨é€æ›´æ–°
        if: env.CHANGES_DETECTED == 'true'
        run: |
          cd target_repo
          # äºŒæ¬¡æ£€æŸ¥æ˜¯å¦æœ‰å¯æäº¤å†…å®¹ï¼ˆé¿å…æ— å˜æ›´æ—¶æ‰§è¡Œï¼‰
          if ! git status --porcelain | grep -v '^??' | grep -q .; then
            echo "â„¹ï¸ æ— å®é™…å˜æ›´ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          TARGET_TOKEN="${{ secrets[env.target_token_name] }}"
          
          git config user.name "Sync Bot"
          git config user.email "sync@noreply.github.com"
          git add . --force
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          CURRENT_DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          SRC_INFO="${{ env.source_user }}/${{ env.source_repo }}:${{ env.source_branch }}[${{ inputs.source_folder || 'æ ¹ç›®å½•' }}]"
          TGT_INFO="${{ env.target_user }}/${{ env.target_repo }}:${{ env.target_branch }}[${{ inputs.target_folder || 'æ ¹ç›®å½•' }}]"
          
          if [ "${{ inputs.commit_template }}" = "ä»…æ—¶é—´" ]; then
            COMMIT_MSG="âœ… ${CURRENT_DATE}"
          elif [ "${{ inputs.commit_template }}" = "åŒæ­¥è¯´æ˜" ]; then
            COMMIT_MSG="ğŸ”„ åŒæ­¥ ${SRC_INFO} â†’ ${TGT_INFO}ï¼ˆ${CURRENT_DATE}ï¼‰"
          elif [ "${{ inputs.commit_template }}" = "è‡ªå®šä¹‰" ]; then
            COMMIT_MSG="${{ inputs.custom_commit_msg }}"
            [ -z "$COMMIT_MSG" ] && COMMIT_MSG="âœ… ${CURRENT_DATE}"
          else
            COMMIT_MSG="âœ… ${CURRENT_DATE}"
          fi
          
          git commit -m "$COMMIT_MSG"
          
          # æ¨é€ï¼ˆè¦†ç›–ç­–ç•¥å¼ºåˆ¶æ¨é€ï¼‰
          PUSH_URL="https://$TARGET_TOKEN@github.com/${{ env.target_user }}/${{ env.target_repo }}.git"
          if [ "${{ inputs.sync_strategy }}" = "è¦†ç›–" ]; then
            git push "$PUSH_URL" ${{ env.target_branch }} --force
          else
            git push "$PUSH_URL" ${{ env.target_branch }}
          fi

      # 9. è¾“å‡ºåŒæ­¥ç»“æœ
      - name: ğŸ“Š åŒæ­¥ç»“æœ
        run: |
          if [ "$CHANGES_DETECTED" = "true" ]; then
            echo "âœ… åŒæ­¥å®Œæˆï¼"
          else
            echo "â„¹ï¸ æºå†…å®¹æ— æ›´æ–°ï¼Œæ— éœ€åŒæ­¥"
          fi

      # 10. å…¨å±€é”™è¯¯å¤„ç†ï¼ˆæ— å˜æ›´æ—¶æ­£å¸¸é€€å‡ºï¼‰
      - name: ğŸ” å…¨å±€ç»“æœå¤„ç†
        if: failure()
        run: |
          if [ "$CHANGES_DETECTED" = "false" ]; then
            echo "â„¹ï¸ æ— å˜æ›´ï¼Œæµç¨‹æ­£å¸¸ç»“æŸ"
            exit 0
          else
            exit 1
          fi
